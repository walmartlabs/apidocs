<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>com.walmartlabs.lacinia.pedestal.subscriptions documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">com.walmartlabs/lacinia-pedestal</span> <span class="project-version">1.1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>com</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>walmartlabs</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lacinia</span></div></div></li><li class="depth-4 branch"><a href="com.walmartlabs.lacinia.async.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>async</span></div></a></li><li class="depth-4"><a href="com.walmartlabs.lacinia.pedestal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pedestal</span></div></a></li><li class="depth-5 branch"><a href="com.walmartlabs.lacinia.pedestal.cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cache</span></div></a></li><li class="depth-5 branch"><a href="com.walmartlabs.lacinia.pedestal.interceptors.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interceptors</span></div></a></li><li class="depth-5 branch"><a href="com.walmartlabs.lacinia.pedestal.spec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec</span></div></a></li><li class="depth-5 current"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>subscriptions</span></div></a></li><li class="depth-4"><a href="com.walmartlabs.lacinia.pedestal2.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>pedestal2</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-default-subscription-interceptors"><div class="inner"><span>default-subscription-interceptors</span></div></a></li><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-exception-handler-interceptor"><div class="inner"><span>exception-handler-interceptor</span></div></a></li><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-execute-operation-interceptor"><div class="inner"><span>execute-operation-interceptor</span></div></a></li><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-inject-app-context-interceptor"><div class="inner"><span>inject-app-context-interceptor</span></div></a></li><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-listener-fn-factory"><div class="inner"><span>listener-fn-factory</span></div></a></li><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-query-parser-interceptor"><div class="inner"><span>query-parser-interceptor</span></div></a></li><li class="depth-1"><a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-send-operation-response-interceptor"><div class="inner"><span>send-operation-response-interceptor</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">com.walmartlabs.lacinia.pedestal.subscriptions</h1><h4 class="added">added in 0.3.0</h4><div class="doc"><div class="markdown"><p>Support for GraphQL subscriptions using Jetty WebSockets, following the design of the Apollo client and server.</p>
</div></div><div class="public anchor" id="var-default-subscription-interceptors"><h3>default-subscription-interceptors</h3><div class="usage"><code>(default-subscription-interceptors compiled-schema app-context)</code></div><div class="doc"><div class="markdown"><p>Processing of operation requests from the client is passed through interceptor pipeline. The context for the pipeline includes special keys for the necessary channels.</p>
<p>The :request key is the payload sent from the client, along with additional keys:</p>
<dl>
<dt>:response-data-ch</dt>
<dd>Channel to which Clojure data destined for the client should be written.</dd>
<dd>This should be closed when the subscription data is exhausted.</dd>
<dt>:shutdown-ch</dt>
<dd>This channel will be closed if the client terminates the connection. For subscriptions, this ensures that the subscription is cleaned up.</dd>
<dt>:id</dt>
<dd>The client-provided string that must be included in the response.</dd>
</dl>
<p>For mutation and query operations, a :response key is added to the context, which triggers a response to the client.</p>
<p>For subscription operations, it’s a bit different; there’s no immediate response, but a new CSP will work with the streamer defined by the subscription to send a sequence of “data” messages to the client.</p>
<ul>
<li>::exception-handler – <a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-exception-handler-interceptor">exception-handler-interceptor</a></li>
<li>::send-operation-response – <a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-send-operation-response-interceptor">send-operation-response-interceptor</a></li>
<li>::query-parser – <a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-query-parser-interceptor">query-parser-interceptor</a></li>
<li>::inject-app-context – <a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-inject-app-context-interceptor">inject-app-context-interceptor</a></li>
<li>::execute-operation – <a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-execute-operation-interceptor">execute-operation-interceptor</a></li>
</ul>
<p>Returns a vector of interceptors.</p>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L445">view source</a></div></div><div class="public anchor" id="var-exception-handler-interceptor"><h3>exception-handler-interceptor</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>An interceptor that implements the :error callback, to send an “error” message to the client.</p>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L238">view source</a></div></div><div class="public anchor" id="var-execute-operation-interceptor"><h3>execute-operation-interceptor</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Executes a mutation or query operation and sets the :response key of the context, or executes a long-lived subscription operation.</p>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L414">view source</a></div></div><div class="public anchor" id="var-inject-app-context-interceptor"><h3>inject-app-context-interceptor</h3><h4 class="added">added in 0.14.0</h4><div class="usage"><code>(inject-app-context-interceptor app-context)</code></div><div class="doc"><div class="markdown"><p>Adds a :lacinia-app-context key to the request, used when executing the query.</p>
<p>The provided app-context map is augmented with the request map, as key :request.</p>
<p>The key is removed on exit (on leave, or on error).</p>
<p>It is not uncommon to replace this interceptor with one that constructs the application context dynamically; for example, to extract authentication information from the request and expose that as app-context keys.</p>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L427">view source</a></div></div><div class="public anchor" id="var-listener-fn-factory"><h3>listener-fn-factory</h3><div class="usage"><code>(listener-fn-factory compiled-schema options)</code></div><div class="doc"><div class="markdown"><p>A factory for the function used to create a WS listener.</p>
<p>This function is invoked for each new client connecting to the service.</p>
<p><code>compiled-schema</code> may be the actual compiled schema, or a no-arguments function that returns the compiled schema.</p>
<p>Once a subscription is initiated, the flow is:</p>
<p>streamer -&gt; values channel -&gt; resolver -&gt; response channel -&gt; send channel</p>
<p>The default channels are all buffered and non-lossy, which means that a very active streamer may be able to saturate the web socket used to send responses to the client. By introducing lossiness or different buffers, the behavior can be tuned.</p>
<p>Each new subscription from the same client will invoke a new streamer and create a corresponding values channel, but there is only one response channel per client.</p>
<p>Options:</p>
<dl>
<dt>:keep-alive-ms (default: 25000)</dt>
<dd>The interval at which keep alive messages are sent to the client. Note that configuring this timeout to be at or above 30s conflicts with a default Jetty timeout closing websockets after 30s of idle time.</dd>
<dt>:app-context</dt>
<dd>The base application context provided to Lacinia when executing a query.</dd>
<dt>:subscription-interceptors</dt>
<dd>A seq of interceptors for processing queries.  The default is derived from <a href="com.walmartlabs.lacinia.pedestal.subscriptions.html#var-default-subscription-interceptors">default-subscription-interceptors</a>.</dd>
<dt>:init-context</dt>
<dd>A function returning the base context for the subscription-interceptors to operate on. The function takes the following arguments:
<ul>
<li>the minimal viable context for operation</li>
<li>the ServletUpgradeRequest that initiated this connection</li>
<li>the ServletUpgradeResponse to the upgrade request Defaults to returning the context unchanged.</li>
</ul>
</dd>
<dt>:response-chan-fn</dt>
<dd>A function that returns a new channel. Responses to be written to client are put into this channel. The default is a non-lossy channel with a buffer size of 10.</dd>
<dt>:values-chan-fn</dt>
<dd>A function that returns a new channel. The channel conveys the values provided by the subscription’s streamer. The values are executed as queries, then transformed into responses that are put into the response channel. The default is a non-lossy channel with a buffer size of 1.</dd>
<dt>:send-buffer-or-n</dt>
<dd>Used to create the channel of text responses sent to the client. The default is 10 (a non-lossy channel).</dd>
</dl>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L484">view source</a></div></div><div class="public anchor" id="var-query-parser-interceptor"><h3>query-parser-interceptor</h3><div class="usage"><code>(query-parser-interceptor compiled-schema)</code></div><div class="doc"><div class="markdown"><p>An interceptor that parses the query and places a prepared and validated query into the :parsed-lacinia-query key of the request.</p>
<p>On exit (on leave, or on error) the key is removed from the request.</p>
<p><code>compiled-schema</code> may be the actual compiled schema, or a no-arguments function that returns the compiled schema.</p>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L283">view source</a></div></div><div class="public anchor" id="var-send-operation-response-interceptor"><h3>send-operation-response-interceptor</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Interceptor responsible for the :response key of the context (set when a request is either a query or mutation, but not a subscription). The :response data is packaged up as the payload of a “data” message to the client, followed by a “complete” message.</p>
</div></div><div class="src-link"><a href="https://github.com/walmartlabs/lacinia-pedestal/blob/master/src/com/walmartlabs/lacinia/pedestal/subscriptions.clj#L251">view source</a></div></div></div></body></html>